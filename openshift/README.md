# Deployment on Openshift

This application is deployed on Openshift. This readme will outline how to setup and configure an Openshift project to get the application to a deployable state. This document assumes a working knowledge of Kubernetes/Openshift container orchestration concepts (i.e. buildconfigs, deployments, imagestreams, secrets, configmaps, routes, networkpolicies, etc) and Red Hat SSO authentication.

This application does not utilize GitHub Actions for CI/CD but direct operations on OpenShift.

## Table of Contents

- [Openshift Deployment Prerequisites](#openshift-deployment-prerequisites)
- [Environment Setup - ConfigMaps and Secrets](#environment-setup---configmaps-and-secrets)
- [Deployment](#deployment)

## Openshift Deployment Prerequisites

We assume you are logged into OpenShift.

### Add Default Kubernetes Network Policies

Before deploying, ensure that you have the following Network Policies:
-  `allow-from-openshift-ingress` copying the YAML from [allow-from-openshift-ingress](./allow-from-openshift-ingress.np.yaml) 
-  `allow-frontend-to-backend` copying the YAML from [allow-frontend-to-backend](./allow-frontend-to-backend.np.yaml) 

In the "Create NetworkPolicy" page.

## Environment Setup - ConfigMaps and Secrets

There are some requirements in the target Openshift namespace/project which are **outside** of the CI/CD pipeline process. This application requires that a few Secrets as well as ConfigMaps are already present in the environment before it is able to function as intended. Otherwise the pipeline will fail the deployment by design.

### ConfigMaps

Go to the +Add screen in OpenShift and copy all from [app.cm](./app.cm.yaml), and add the appropriate values left empty under each data section. These values can be collected from your Keycloak SSO provider.

**medis-rls-file-config** is a leftover artifact from the CHEFS deployment, it can be filled with the following arbitrary values:

- FILES_UPLOADS_DIR=
- FILES_UPLOADS_ENABLED=true
- FILES_UPLOADS_FILECOUNT=1
- FILES_UPLOADS_FILEKEY=files
- FILES_UPLOADS_FILEMAXSIZE=25MB
- FILES_UPLOADS_FILEMINSIZE=0KB
- FILES_UPLOADS_PATH=files
- FILES_PERMANENT=localStorage
- FILES_LOCALSTORAGE_PATH=/files

### Secrets

Go to the +Add screen in OpenShift and copy all from [app.secret](./app.secret.yaml), and add the appropriate values left empty under each data section. These values can be collected from your Keycloak SSO provider.

**medis-rls-objectstorage-secret** is a leftover deployment artifact from CHEFS, this can be filled with any value (i.e. "dummy") to make sure the deployment pass.

For _medis-rls-secret_, generate 2 random 32-char alphanumeric strings using `openssl rand -base64` or similar commands, and use them as the externalapikey and webhooksecret. mailapitoken is the CHES secrets which can be collected from your CHES integrations.

## Deployment

This application is currently designed as a single application pod deployment. It will host a static frontend containing all of the Vue.js resources and assets, and a Node.js backend which serves the API that the frontend requires. We are currently leveraging Openshift Routes with path based filtering to forward incoming traffic to the right deployment service.

### Application

The backend is a standard [Node](https://nodejs.org)/[Express](https://expressjs.com) server. It handles the JWT based authentication via OIDC authentication flow, and exposes the API to authorized users. This deployment container is built up on top of an Alpine Node image. The resulting container after build is what is deployed.

Go to the +Add screen in OpenShift and copy all from [app.d](./app.d.yaml), using the copy and replace, replace the following values with the value described:

- ${{ IMAGE_TAG }}: the image tag
- ${{ ENVIRONMENT }}: the environment you're deploying to
- ${{ TOOL_NAMESPACE }}: the tools namespace name
- ${{ DATABASE_SECRET_NAME }}: the database secret generated by the Patroni Helm deployment
- ${{ IMAGE_LINK }}: Internal link to the initial image, this can be created using 'image-registry.openshift-image-registry.svc:5000/${{ TOOL_NAMESPACE }}/medis-rls:${{ IMAGE_TAG }}'